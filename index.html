<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIENDAS ZHEGOO 2025 - Inventario Local</title>
    <!-- Incluye Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        emerald: {
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857',
                        },
                        // Colores para el tema oscuro
                        dark: {
                            bg: '#121212',
                            card: '#1e1e1e',
                            text: '#f3f4f6',
                            primary: '#64ffda', // Verde neón para acentos
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos base para los temas */
        :root {
            --color-bg: #f3f4f6;
            --color-card: #ffffff;
            --color-text: #374151; /* Color de texto principal (oscuro por defecto) */
            --color-primary: #10b981;
            --color-primary-shadow: rgba(16, 185, 129, 0.7);
            --color-input-bg: #f9fafb;
            --color-input-text: #1f2937; /* Color de texto en inputs (negro) */
            --color-placeholder: #6b7280;
            --color-table-header: #f9fafb;
            --base-font-size: 14px; /* Default */
        }

        .dark-mode {
            --color-bg: #121212;
            --color-card: #1e1e1e;
            --color-text: #f3f4f6; /* Texto principal debe ser CLARO */
            --color-primary: #64ffda;
            --color-primary-shadow: rgba(100, 255, 218, 0.7);
            --color-input-bg: #2d2d2d;
            --color-input-text: #121212; /* NUEVO: Texto de inputs en negro para contraste */
            --color-card-text-dark: #121212; /* Color negro específico para inputs en modo oscuro */
            --color-placeholder: #9ca3af;
            --color-table-header: #2d2d2d; /* Fondo de encabezado oscuro */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg); 
            color: var(--color-text);
            transition: background-color 0.3s, color 0.3s;
            font-size: var(--base-font-size); /* Usa la variable */
        }

        /* APLICACIÓN CRÍTICA PARA EL TAMAÑO DE FUENTE: 
           Usamos unidades relativas (rem) o herencia para que la fuente base tenga efecto.
           Hemos quitado las clases de tamaño fijas de Tailwind y usamos CSS para el tamaño. */
        .main-card label, .main-card button, .main-card input, .main-card select {
            font-size: calc(var(--base-font-size) / 16 * 1rem); /* Base size */
        }
        .main-card h1 {
            font-size: calc(var(--base-font-size) / 16 * 2.25rem); /* Proporcional a text-3xl */
        }
        .main-card h2 {
            font-size: calc(var(--base-font-size) / 16 * 1.25rem); /* Proporcional a text-xl */
        }
        .main-card .text-xs {
            font-size: calc(var(--base-font-size) / 16 * 0.75rem); /* Proporcional a text-xs */
        }
        .main-card .text-sm {
            font-size: calc(var(--base-font-size) / 16 * 0.875rem); /* Proporcional a text-sm */
        }
        .main-card .text-lg {
            font-size: calc(var(--base-font-size) / 16 * 1.125rem); /* Proporcional a text-lg */
        }
        .main-card .text-base {
            font-size: calc(var(--base-font-size) / 16 * 1rem); /* Proporcional a text-base */
        }
        
        /* Aplicación de colores del tema a los elementos */
        .main-card {
            background-color: var(--color-card);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border-top-color: var(--color-primary) !important;
            transition: background-color 0.3s, box-shadow 0.3s, color 0.3s;
        }
        
        /* CORRECCIÓN DE CONTRASTE EN MODO OSCURO */
        
        /* Estilos generales para texto y títulos */
        .main-card h1, .main-card h2, .main-card label, .main-card p, .main-card select { 
            color: var(--color-text); 
        }

        /* Estilos específicos para inputs y celdas de tabla (nombres de productos) */
        .main-card input[type="text"], 
        .main-card input[type="number"], 
        .main-card td.product-name-cell,
        .main-card th {
             /* En modo claro: texto oscuro */
            color: var(--color-input-text);
        }
        
        .dark-mode .main-card input[type="text"], 
        .dark-mode .main-card input[type="number"], 
        .dark-mode .main-card td.product-name-cell {
            /* En modo oscuro: forzamos el texto a ser negro */
            color: var(--color-card-text-dark) !important; 
        }
        
        /* Aseguramos que el encabezado y el texto principal de la tabla usen el color del texto CLARO en modo oscuro */
        .bg-gray-50 tbody th {
             color: var(--color-text); 
             background-color: var(--color-table-header);
        }
        
        /* Estilos de la tabla y hover */
        .bg-white { background-color: var(--color-card); }
        .hover\:bg-gray-50:hover { background-color: var(--color-table-header); }
        
        /* Colores de texto en el menú de Engrane (Debe ser CLARO en modo oscuro) */
        .settings-menu .text-gray-900, 
        .settings-menu .text-gray-700 {
            color: var(--color-text) !important;
        }

        /* FIN CORRECCIÓN DE CONTRASTE */
        
        /* Estilos de animaciones y otros */
        .container-main {
            min-height: 100vh;
        }
        .listening-animation {
            animation: pulse-ring 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-ring {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 var(--color-primary-shadow); 
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
        }
        .listening-dot {
            animation: bounce 1s infinite;
        }
        /* Estilos del menú flotante de engrane */
        .settings-menu {
            transition: all 0.3s ease-out;
            transform: scale(0.95);
            opacity: 0;
            transform-origin: top right;
            visibility: hidden;
            background-color: var(--color-card); /* Asegurar el fondo del menú */
        }
        .settings-menu.open {
            transform: scale(1);
            opacity: 1;
            visibility: visible;
        }
        /* Estilo para filas de la tabla */
        #productsTableBody tr[data-doc-id] {
            display: table-row;
        }
        #productsTableBody tr.filtered-out {
            display: none;
        }
        /* Ocultar el ID de usuario en la interfaz móvil, ya que no se necesita para localStorage */
        @media (max-width: 640px) {
            #db-status {
                display: none;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center p-4 container-main">

    <!-- Ícono flotante ZHEGOO -->
    <div class="fixed top-4 left-4 z-50">
        <div class="text-xl font-extrabold text-white bg-purple-600 px-3 py-1 rounded-full shadow-lg">Zhegoo</div>
    </div>

    <!-- Menú de Engrane Flotante -->
    <div class="fixed top-4 right-4 z-50">
        <button id="settingsButton" class="p-3 rounded-full bg-gray-700 text-white shadow-lg hover:bg-gray-800 transition duration-150">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37h.001z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>

        <!-- Menú Desplegable -->
        <div id="settingsMenu" class="settings-menu absolute right-0 mt-2 w-64 rounded-md shadow-2xl ring-1 ring-black ring-opacity-5 divide-y divide-gray-100">
            <div class="px-4 py-3">
                <p class="text-sm font-medium text-gray-900">Opciones</p>
            </div>
            <div class="p-2 space-y-2">
                <p class="text-xs font-semibold text-gray-700 px-2 pt-1">ACCESIBILIDAD</p>
                
                <!-- Opcion 1: Tema -->
                <div class="flex items-center justify-between px-2 py-1">
                    <span class="text-sm text-gray-700">Modo Oscuro</span>
                    <button id="themeToggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 bg-gray-200" data-checked="false">
                        <span class="sr-only">Toggle dark mode</span>
                        <span aria-hidden="true" class="inline-block w-5 h-5 transform bg-white rounded-full shadow transition ease-in-out duration-200 translate-x-1"></span>
                    </button>
                </div>
                
                <!-- Opcion 2: Tamaño de Fuente -->
                <div class="px-2">
                    <label for="fontSizeSlider" class="block text-sm font-medium text-gray-700 mb-1">Tamaño de Fuente:</label>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm">A</span>
                        <!-- MAX AUMENTADO A 24 -->
                        <input type="range" id="fontSizeSlider" min="10" max="24" value="14" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                        <span class="text-lg">A</span>
                    </div>
                </div>

            </div>
            
            <div class="p-2 space-y-2">
                <p class="text-xs font-semibold text-gray-700 px-2 pt-1">DATOS Y BACKUP</p>
                
                <!-- Copia de Seguridad Programada -->
                <div class="px-2">
                    <label for="backupInterval" class="block text-sm font-medium text-gray-700 mb-1">Programar Copia de Seguridad:</label>
                    <select id="backupInterval" class="w-full p-2 border border-gray-300 rounded-md text-sm">
                        <option value="manual">Manual (Ahora)</option>
                        <option value="daily">Cada 24 horas</option>
                        <option value="3days">Cada 3 días</option>
                        <option value="5days">Cada 5 días</option>
                        <option value="monthly">Mensualmente</option>
                    </select>
                </div>

                <!-- Lista de Backups Guardados -->
                <div class="px-2 pt-2">
                    <p class="text-xs font-medium text-gray-700 mb-1">Backups guardados:</p>
                    <ul id="backupList" class="max-h-24 overflow-y-auto border border-gray-200 rounded-md p-1 space-y-1">
                        <!-- Se llenará con JS -->
                        <li class="text-xs text-gray-500 text-center">No hay backups.</li>
                    </ul>
                </div>

                <label for="csvFileInput" class="block text-xs font-medium text-gray-700 mb-1 px-2">Carga Masiva (CSV)</label>
                <input type="file" id="csvFileInput" accept=".csv" class="text-xs w-full mb-2 p-1 border border-gray-300 rounded-md">
                
                <button id="backupButton" class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-yellow-50 hover:text-yellow-700 transition duration-150 rounded-md">
                    <svg class="w-5 h-5 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Generar Copia de Seguridad
                </button>
            </div>
        </div>
    </div>
    <!-- FIN Menú de Engrane Flotante -->

    <div class="w-full max-w-6xl main-card p-4 sm:p-8 rounded-xl shadow-2xl border-t-8 border-emerald-500">
        
        <!-- Título principal simplificado -->
        <header class="mb-6 border-b pb-4">
            <h1 class="text-2xl sm:text-3xl font-extrabold flex items-center justify-center text-center">
                <!-- Icono de Tienda -->
                🛒🛍️
                TIENDAS ZHEGOO 2025
            </h1>
            <p id="db-status" class="hidden"></p>
        </header>

        <!-- Bloque de Acciones Principales (Voz) -->
        <section class="flex flex-col sm:flex-row gap-4 mb-8 justify-center">
            
            <!-- Botón Agregar por Voz (Guardado Automático) -->
            <button id="startAddButton" class="w-full sm:w-1/2 flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-lg text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-150 ease-in-out">
                <!-- ÍCONO DE CRUZ (╋) EN UN SPAN PARA MANEJAR EL TAMAÑO DE FUENTE -->
                <span class="mr-2 text-xl">╋</span>
                <span id="startAddButtonText" class="text-base">Agregar productos por voz</span>
            </button>

            <!-- Botón Buscar por Voz y TTS -->
            <button id="startSearchButton" class="w-full sm:w-1/2 flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                <!-- ÍCONO DE MICRÓFONO (🎙️) EN UN SPAN PARA MANEJAR EL TAMAÑO DE FUENTE -->
                <span class="mr-2 text-xl">🎙️</span>
                <span id="startSearchButtonText" class="text-base">Buscar producto por voz</span>
            </button>
        </section>

        <!-- Divs de Entrada y Estado (Visibles para Voice y Manual) -->
        <section class="grid md:grid-cols-3 gap-4 mb-6">
            <div class="md:col-span-2 space-y-4">
                <input type="hidden" id="docIdInput" value="">
                
                <!-- Campo de Producto y Búsqueda Manual -->
                <div class="relative">
                    <label for="productNameInput" class="block text-sm font-medium mb-1">Producto / Búsqueda:</label>
                    <input type="text" id="productNameInput" placeholder="Nombre (Escribir o usar Voz)" 
                           class="w-full p-3 text-lg bg-gray-50 border-2 border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
                    <!-- Botón de Búsqueda Manual -->
                    <button id="manualSearchButton" class="absolute right-0 top-7 mt-1 mr-1 p-2 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600 transition duration-150">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </button>
                </div>

                <!-- Campo de Precio -->
                <div>
                    <label for="priceInput" class="block text-sm font-medium mb-1">Costo (S/.):</label>
                    <input type="number" step="0.01" id="priceInput" placeholder="0.00" 
                           class="w-full p-3 text-lg text-center font-mono bg-gray-50 border-2 border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
                </div>
            </div>
            
            <!-- Botones CRUD Manual -->
            <div class="md:col-span-1 flex flex-col justify-center space-y-3 mt-8 md:mt-0">
                <button id="manualSaveButton" class="w-full px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-lg text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out">
                    Guardar / Modificar Manual
                </button>
                <button id="clearFormButton" class="w-full px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-lg text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-150 ease-in-out">
                    Limpiar Formulario
                </button>
            </div>

            <!-- Div de estado y mensajes de error -->
            <div id="status" class="md:col-span-3 mt-2 text-center text-sm p-3 rounded-lg min-h-12 bg-gray-100 text-gray-600 border border-gray-300">
                
            </div>
        </section>

        <!-- Sección de Tabla de Productos -->
        <section class="mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Lista de Artículos Guardados</h2>
                <button id="clearFilterButton" class="px-3 py-1 text-sm bg-yellow-500 text-white rounded-md shadow-md hover:bg-yellow-600 transition duration-150 hidden">
                    Mostrar Todos (Filtro Activo)
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Producto</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider">Costo (S/.)</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Las filas de la tabla se insertarán aquí por JavaScript -->
                        <tr><td colspan="3" class="text-center py-4 text-gray-500 border-color:rgb(203 208 219)">Cargando productos...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // Referencias del DOM
        const productNameInput = document.getElementById('productNameInput');
        const priceInput = document.getElementById('priceInput');
        const docIdInput = document.getElementById('docIdInput');
        const startAddButton = document.getElementById('startAddButton');
        const startSearchButton = document.getElementById('startSearchButton');
        const startAddButtonText = document.getElementById('startAddButtonText');
        const startSearchButtonText = document.getElementById('startSearchButtonText');
        const manualSaveButton = document.getElementById('manualSaveButton');
        const clearFormButton = document.getElementById('clearFormButton');
        const csvFileInput = document.getElementById('csvFileInput');
        const backupButton = document.getElementById('backupButton');
        const settingsButton = document.getElementById('settingsButton');
        const settingsMenu = document.getElementById('settingsMenu');
        const statusDiv = document.getElementById('status');
        const productsTableBody = document.getElementById('productsTableBody');
        const clearFilterButton = document.getElementById('clearFilterButton'); 
        const manualSearchButton = document.getElementById('manualSearchButton'); 
        const themeToggle = document.getElementById('themeToggle'); 
        const fontSizeSlider = document.getElementById('fontSizeSlider'); 
        const backupIntervalSelect = document.getElementById('backupInterval'); // Nuevo select
        const backupList = document.getElementById('backupList'); // Nueva lista

        // Configuración de la Web Speech API
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const SpeechSynthesis = window.speechSynthesis;
        const LOCAL_STORAGE_KEY = 'voice_inventory_products';
        const SETTINGS_KEY = 'app_settings'; 
        const BACKUP_LOG_KEY = 'backup_log'; // Nueva clave para log de backups

        let currentMode = 'add';
        let isRecognizing = false;
        let recognition = null;
        let currentProductsData = []; 
        let currentSettings = { theme: 'light', fontSize: 14 }; 
        let backupTimer = null; // Para control de programación
        let backupLog = [];

        if (!SpeechRecognition) {
            statusDiv.innerHTML = '<p class="text-red-600 font-bold">❌ API de Voz no soportada. Usa Chrome o Edge.</p>';
            startAddButton.disabled = true;
            startSearchButton.disabled = true;
        } else {
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.continuous = false;
            recognition.interimResults = false;
        }

        // --- FUNCIONES DE ACCESIBILIDAD ---

        const loadSettings = () => {
            const storedSettings = localStorage.getItem(SETTINGS_KEY);
            if (storedSettings) {
                currentSettings = JSON.parse(storedSettings);
            }
            applySettings();
        };

        const saveSettings = () => {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(currentSettings));
            applySettings();
        };

        const applySettings = () => {
            const body = document.body;
            const root = document.documentElement; // Usamos :root para variables CSS
            
            // 1. Tema
            if (currentSettings.theme === 'dark') {
                root.classList.add('dark-mode');
                themeToggle.setAttribute('data-checked', 'true');
                themeToggle.classList.remove('bg-gray-200');
                themeToggle.classList.add('bg-blue-600');
                themeToggle.querySelector('span').classList.add('translate-x-5');
                themeToggle.querySelector('span').classList.remove('translate-x-1');
            } else {
                root.classList.remove('dark-mode');
                themeToggle.setAttribute('data-checked', 'false');
                themeToggle.classList.remove('bg-blue-600');
                themeToggle.classList.add('bg-gray-200');
                themeToggle.querySelector('span').classList.remove('translate-x-5');
                themeToggle.querySelector('span').classList.add('translate-x-1');
            }

            // 2. Fuente (Corregido: Usando la variable CSS)
            root.style.setProperty('--base-font-size', `${currentSettings.fontSize}px`);
            fontSizeSlider.value = currentSettings.fontSize;
        };
        
        // Manejador del Toggle de Tema
        themeToggle.addEventListener('click', () => {
            const isChecked = themeToggle.getAttribute('data-checked') === 'true';
            currentSettings.theme = isChecked ? 'light' : 'dark';
            saveSettings();
        });

        // Manejador del Slider de Fuente
        fontSizeSlider.addEventListener('input', (e) => {
            currentSettings.fontSize = parseInt(e.target.value);
            saveSettings();
        });


        // --- FUNCIÓN DE UTILIDAD DE CONVERSIÓN DE VOZ ---
        const numberMap = {
            'cero': 0, 'uno': 1, 'dos': 2, 'tres': 3, 'cuatro': 4, 'cinco': 5,
            'seis': 6, 'siete': 7, 'ocho': 8, 'nueve': 9, 'diez': 10,
            'once': 11, 'doce': 12, 'trece': 13, 'catorce': 14, 'quince': 15,
            'dieciséis': 16, 'diecisiete': 17, 'dieciocho': 18, 'diecinueve': 19,
            'veinte': 20, 'veintiuno': 21, 'veintidós': 22, 'veintitrés': 23, 'veinticuatro': 24,
            'veinticinco': 25, 'veintiséis': 26, 'veintisiete': 27, 'veintiocho': 28, 'veintinueve': 29,
            'treinta': 30, 'cuarenta': 40, 'cincuenta': 50, 'sesenta': 60,
            'setenta': 70, 'ochenta': 80, 'noventa': 90, 'cien': 100,
            'doscientos': 200, 'trescientos': 300, 'cuatrocientos': 400,
            'quinientos': 500, 'seiscientos': 600, 'setecientos': 700,
            'ochocientos': 800, 'novecientos': 900
        };

        const wordsToNumber = (text) => {
            // ... (Lógica de wordsToNumber sin cambios, ya es correcta) ...
            const convert = (numStr) => {
                let total = 0;
                const parts = numStr.split(' ');
                let currentSum = 0;
                for (const part of parts) {
                    if (!part || part === 'y') continue;
                    const value = numberMap[part];
                    if (value !== undefined) {
                        if (value >= 100) { total += value; currentSum = 0; } 
                        else if (value >= 20 && value <= 90) { currentSum += value; } 
                        else if (value >= 1 && value <= 29) { currentSum += value; }
                    }
                }
                total += currentSum;
                return total > 0 || text.includes('cero') ? total.toString() : null;
            };

            let cleanInput = text.trim().toLowerCase().replace(/[^a-zñáéíóúü\s]/g, '');
            cleanInput = cleanInput.replace(/ciento\b/g, 'cien');
            
            const decimalSeparators = ['punto', 'coma', 'con'];
            let integerPart = cleanInput;
            let decimalPart = null;

            for (const separator of decimalSeparators) {
                if (cleanInput.includes(separator)) {
                    [integerPart, decimalPart] = cleanInput.split(separator, 2).map(s => s.trim());
                    break;
                }
            }

            let finalNumber = convert(integerPart);
            
            if (finalNumber && decimalPart) {
                let decimalNum = '';
                const decimalWords = decimalPart.split(' ').filter(w => w in numberMap);
                
                if (decimalWords.length > 0) {
                    let tempDecimalNum = convert(decimalPart);
                    if (tempDecimalNum !== null) decimalNum = tempDecimalNum;
                    
                    if (decimalWords.length === 2 && numberMap[decimalWords[0]] === 0 && decimalNum.length === 1) {
                         decimalNum = numberMap[decimalWords[1]].toString().padStart(2, '0');
                    }
                    
                    if (decimalNum.length === 1) decimalNum += '0';
                    if (decimalNum.length > 2) decimalNum = decimalNum.substring(0, 2); 
                    finalNumber = `${finalNumber}.${decimalNum}`;
                }
            }
            
            return finalNumber;
        };

        const parseProductAndPrice = (transcript) => {
            // ... (Lógica de parseProductAndPrice sin cambios) ...
            let lowerTranscript = transcript.trim().toLowerCase();
            let product = transcript.trim();
            let price = null;
            
            const separatorRegex = /\b(precio|cuesta|es|son|valor|vale|por|total|el|la)\b/g;
            let lastSeparatorIndex = -1;
            let match;
            
            while ((match = separatorRegex.exec(lowerTranscript)) !== null) {
                lastSeparatorIndex = match.index;
            }

            let productPart = lowerTranscript;
            let pricePart = '';
            
            if (lastSeparatorIndex !== -1) {
                productPart = lowerTranscript.substring(0, lastSeparatorIndex).trim();
                pricePart = lowerTranscript.substring(lastSeparatorIndex).trim();
            } else {
                pricePart = lowerTranscript;
            }

            let numericalPrice = wordsToNumber(pricePart);

            if (numericalPrice === null) {
                const digitMatch = pricePart.match(/(-?\s*(\d+(\.\d*)?))/);
                if (digitMatch) {
                    numericalPrice = digitMatch[1].replace(/\s/g, '');
                }
            }
            
            if (numericalPrice !== null && !isNaN(parseFloat(numericalPrice))) {
                price = numericalPrice;

                if (productPart.length > 0) {
                    product = productPart.trim();
                } else {
                    const priceStringRegex = new RegExp(numericalPrice.replace('.', '\\.'), 'g');
                    const index = lowerTranscript.search(priceStringRegex);
                    if (index !== -1) {
                        product = lowerTranscript.substring(0, index).trim();
                    } else {
                        product = lowerTranscript.replace(/(-?\s*(\d+)\.?(\d*))\s*$/g, '').trim();
                    }
                }
                
                product = product.replace(/(\s*[-.\d]+\s*)$/g, '').trim();
                if (product.length === 0) product = "Producto Desconocido";
                product = product.charAt(0).toUpperCase() + product.slice(1);
            }

            return { product: product, price: price };
        };
        
        // --- FUNCIÓN DE BÚSQUEDA INTELIGENTE (FILTRO FUZZY) ---
        
        /**
         * Limpia y normaliza el texto para la búsqueda (maneja V/B, espacios, K/C, etc.)
         * @param {string} text 
         */
        const normalizeText = (text) => {
            if (!text) return '';
            let normalized = text.toLowerCase().trim();
            
            // 1. Manejo de B/V y otros errores fonéticos comunes en español
            normalized = normalized.replace(/v/g, 'b'); 
            normalized = normalized.replace(/c/g, 'k'); // K/C para incakola vs inkakola
            normalized = normalized.replace(/s\s*$/g, ''); // Quitar 's' final (plural)
            
            // 2. Simplificar nombres compuestos/sin espacio (prestobarba vs presto barba)
            normalized = normalized.replace(/\s+/g, ''); // Quita todos los espacios
            
            return normalized;
        };

        const performSearch = (queryText) => {
             
            let cleanQuery = queryText.trim().replace(/^[.,:;!?\s]+|[.,:;!?\s]+$/g, '');
            productNameInput.value = cleanQuery; // Mostrar el texto de la búsqueda (Req. 4)

            const normalizedQuery = normalizeText(cleanQuery);

            if (normalizedQuery.length === 0) {
                 clearTableFilter();
                 return;
            }

            statusDiv.innerHTML = `<p class="text-blue-600 font-bold">🔎 Buscando "${cleanQuery}" (búsqueda parcial)...</p>`;

            // 1. Filtrar localmente usando normalización (Filtro Fuzzy)
            const filteredProducts = currentProductsData.filter(p => {
                const normalizedProductName = normalizeText(p.productName);
                
                // Criterios de coincidencia más flexible:
                // a) Coincidencia directa de la palabra normalizada (ej: 'aceite' incluye 'aceit')
                // b) Coincidencia de la palabra normalizada sin espacios (ej: 'prestobarba' incluye 'presto barba')
                
                const matchFound = normalizedProductName.includes(normalizedQuery);
                
                return matchFound;
            });

            // 2. Filtrar el DOM (resto del código sin cambios)
            const allRows = productsTableBody.querySelectorAll('tr[data-doc-id]');
            let matchCount = 0;
            
            allRows.forEach(row => {
                const productId = row.getAttribute('data-doc-id');
                const isMatch = filteredProducts.some(p => p.id === productId);

                if (isMatch) {
                    row.classList.remove('filtered-out');
                    matchCount++;
                } else {
                    row.classList.add('filtered-out');
                }
            });

            // 3. Mostrar botón para limpiar filtro
            clearFilterButton.classList.remove('hidden');
            
            return filteredProducts;
        }

        // --- FUNCIONES DE ALMACENAMIENTO LOCAL (CRUD y SEED) ---
        const loadProducts = () => {
            // ... (Lógica de loadProducts sin cambios) ...
            const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!storedData) {
                return seedDatabase(); // Si no hay datos, sembramos
            }
            try {
                let products = JSON.parse(storedData);
                
                products = products.map(p => ({
                    ...p,
                    id: p.id || crypto.randomUUID(),
                    timestamp: p.timestamp || Date.now()
                }));

                products.sort((a, b) => b.timestamp - a.timestamp);
                return products;
            } catch (e) {
                console.error("Error al parsear datos de localStorage:", e);
                return [];
            }
        };

        const saveProducts = (products) => {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(products));
            return products;
        };

        const productsToSeed = [
            'Leche entera', 'Pan de molde', 'Huevos (docena)', 'Azúcar blanca', 'Aceite vegetal',
            'Arroz blanco', 'Fideos spaghetti', 'Atún enlatado', 'Sal de mesa', 'Café molido',
            'Té filtrante', 'Yogurt natural', 'Mantequilla', 'Queso fresco', 'Jugo de naranja',
            'Manzanas rojas', 'Plátanos', 'Papas blancas', 'Cebollas', 'Tomates',
            'Zanahorias', 'Lechuga', 'Pollo entero', 'Carne molida', 'Pescado (Tilapia)',
            'Gaseosa cola', 'Agua embotellada', 'Cerveza rubia', 'Vino tinto', 'Harina de trigo',
            'Detergente ropa', 'Suavizante', 'Lavavajillas', 'Cloro', 'Papel higiénico',
            'Jabón de tocador', 'Champú', 'Acondicionador', 'Pasta dental', 'Cepillo de dientes',
            'Galletas soda', 'Chocolate en barra', 'Miel de abeja', 'Frijoles canario', 'Lentejas',
            'Maíz chancha', 'Palta (unidad)', 'Limones', 'Cilantro', 'Avena en bolsa'
        ];
        const generateRandomPrice = (min, max) => (Math.random() * (max - min) + min).toFixed(2);
        const seedDatabase = () => {
            const products = [];
            for (let i = 0; i < productsToSeed.length; i++) {
                products.push({
                    id: crypto.randomUUID(), 
                    productName: productsToSeed[i],
                    price: parseFloat(generateRandomPrice(2.5, 35.0)),
                    timestamp: Date.now() - i * 1000 
                });
            }
            statusDiv.innerHTML = '<p class="text-green-600 font-bold">Base de datos local inicializada con 50 productos.</p>';
            return saveProducts(products);
        };
        
        // --- FUNCIONES DE RENDERING Y LECTURA ---
        
        /**
         * Lee un texto usando Speech Synthesis (TTS).
         */
        const readResults = (text) => {
            if (!SpeechSynthesis) {
                console.warn("Speech Synthesis no soportado.");
                return;
            }
            
            SpeechSynthesis.cancel(); // Detiene cualquier lectura anterior
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            utterance.rate = 1.5; // Velocidad acelerada a 1.5
            utterance.pitch = 1.0; 

            if (currentMode === 'search') {
                 startSearchButton.classList.add('tts-active');
                 utterance.onstart = () => statusDiv.innerHTML = '';
                 utterance.onend = () => startSearchButton.classList.remove('tts-active');
                 utterance.onerror = () => startSearchButton.classList.remove('tts-active');
            }

            SpeechSynthesis.speak(utterance);
        };

        /**
         * Renderiza la tabla de productos
         */
        const renderProductsTable = () => {
            currentProductsData = loadProducts(); // Cargar la data actual

            productsTableBody.innerHTML = '';
            
            if (currentProductsData.length === 0) {
                productsTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500 text-sm">No hay productos guardados.</td></tr>';
                return;
            }

            const fragment = document.createDocumentFragment();

            currentProductsData.forEach((data) => {
                const id = data.id;
                const priceDisplay = parseFloat(data.price).toFixed(2);

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-100';
                row.setAttribute('data-doc-id', id);

                row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium product-name-cell">${data.productName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-bold text-green-700">S/. ${priceDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button data-action="edit" data-id="${id}" class="text-purple-600 hover:text-purple-900 mr-2 px-2 py-1 rounded-md bg-purple-100 transition duration-150 text-xs">
                                Modificar
                            </button>
                            <!-- BOTÓN RENOMBRADO A BORRAR -->
                            <button data-action="delete" data-id="${id}" data-name="${data.productName}" class="text-red-600 hover:text-red-900 px-2 py-1 rounded-md bg-red-100 transition duration-150 text-xs">
                                Borrar
                            </button>
                        </td>
                    `;
                
                fragment.appendChild(row);
            });
            
            productsTableBody.appendChild(fragment);

            // Adjuntar event listeners después de que el DOM está listo
            productsTableBody.querySelectorAll('button[data-action="edit"]').forEach(button => {
                button.addEventListener('click', () => editProduct(button.getAttribute('data-id')));
            });
            productsTableBody.querySelectorAll('button[data-action="delete"]').forEach(button => {
                button.addEventListener('click', () => {
                    const id = button.getAttribute('data-id');
                    const name = button.getAttribute('data-name');
                    deleteProduct(id, name);
                });
            });
        };


        // --- FUNCIONES CRUD LOCALES ---
        
        /**
         * Guarda un nuevo producto (desde voz).
         */
        const saveProductFromVoice = (product, price) => {
            // ... (Lógica sin cambios) ...
            if (!product || isNaN(parseFloat(price))) return;

            const finalPrice = parseFloat(price);
            
            const newProduct = {
                id: crypto.randomUUID(),
                productName: product,
                price: finalPrice,
                timestamp: Date.now()
            };

            const updatedProducts = [newProduct, ...currentProductsData];
            saveProducts(updatedProducts); // Guardar en localStorage
            renderProductsTable(); // Actualizar la tabla

            const priceForSpeech = finalPrice.toFixed(2).replace('.', ' con '); // Ejemplo: 2.50 -> "2 con 50"

            const message = `Producto "${product}" con precio de ${finalPrice.toFixed(2)} soles guardado automáticamente.`;
            productNameInput.value = '';
            priceInput.value = '';
            statusDiv.innerHTML = `<p class="text-green-600 font-bold">✅ ${message}</p>`;
            
            // TTS CONCISO: No dice "soles" ni "punto"
            readResults(`Guardado. ${product} a ${priceForSpeech}.`);
        };

        /**
         * Carga el producto seleccionado en el formulario para su edición.
         */
        const editProduct = (id) => {
            const product = currentProductsData.find(p => p.id === id);

            if (product) {
                docIdInput.value = id;
                productNameInput.value = product.productName;
                priceInput.value = parseFloat(product.price).toFixed(2);
                statusDiv.innerHTML = `<p class="text-purple-600 font-bold">📝 Editando: ${product.productName}. Presiona Guardar / Modificar Manual.</p>`;
                settingsMenu.classList.remove('open');
            }
        };

        /**
         * Elimina un producto.
         */
        const deleteProduct = (id, name) => {
            // Confirmación del usuario 
            if (!window.confirm(`¿Estás seguro de que quieres borrar permanentemente el producto "${name}"?`)) {
                return;
            }
            
            // Filtrar el producto de la lista actual
            const updatedProducts = currentProductsData.filter(p => p.id !== id);
            
            // Guardar la nueva lista en localStorage
            saveProducts(updatedProducts);
            
            // Re-renderizar la tabla para reflejar el cambio
            renderProductsTable();
            
            statusDiv.innerHTML = `<p class="text-red-600 font-bold">🗑️ Producto "${name}" borrado exitosamente.</p>`;
            clearForm();
        };

        // Exportar funciones CRUD para botones de tabla
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;


        // Limpiar el formulario de edición
        const clearForm = () => {
            docIdInput.value = '';
            productNameInput.value = '';
            priceInput.value = '';
            statusDiv.innerHTML = '';
            clearTableFilter();
        };
        
        // Asignar evento al botón de Guardado/Modificación Manual
        document.getElementById('manualSaveButton').addEventListener('click', () => {
            const product = productNameInput.value.trim();
            const price = parseFloat(priceInput.value);
            const docId = docIdInput.value;

            if (!product || isNaN(price)) {
                statusDiv.innerHTML = '<p class="text-red-600 font-bold">❌ Error: El producto o el precio no son válidos.</p>';
                return;
            }

            let updatedProducts;
            if (docId) {
                // MODIFICAR
                updatedProducts = currentProductsData.map(p => {
                    if (p.id === docId) {
                        return { ...p, productName: product, price: price, timestamp: Date.now() };
                    }
                    return p;
                });
                statusDiv.innerHTML = `<p class="text-purple-600 font-bold">🔄 Producto "${product}" modificado exitosamente.</p>`;
            } else {
                // GUARDAR NUEVO
                const newProduct = {
                    id: crypto.randomUUID(),
                    productName: product,
                    price: price,
                    timestamp: Date.now()
                };
                updatedProducts = [newProduct, ...currentProductsData]; // Añadir al inicio para que aparezca primero
                statusDiv.innerHTML = `<p class="text-green-600 font-bold">✅ Producto "${product}" guardado manualmente.</p>`;
            }
            
            saveProducts(updatedProducts);
            renderProductsTable();
            clearForm();
        });

        document.getElementById('clearFormButton').addEventListener('click', clearForm);


        // --- FUNCIONES DE BÚSQUEDA Y LECTURA (TTS) ---

        const performSearchAndRead = (queryText) => {
            
            const filteredProducts = performSearch(queryText);

            // 4. Generar y leer la respuesta TTS
            let speechText = "";
            
            if (filteredProducts.length === 0) {
                speechText = `No se encontraron artículos similares a ${queryText}.`;
            } else {
                speechText = `Se encontraron ${filteredProducts.length} artículos: `;
                
                filteredProducts.forEach((p, index) => {
                    // TTS: Convertir a formato de voz limpio (sin "soles")
                    const price = parseFloat(p.price).toFixed(2).replace('.', ' con '); 
                    speechText += `${p.productName} a ${price}.`;
                    if (index < filteredProducts.length - 1) {
                        speechText += ' Y '; 
                    }
                });
            }
            
            readResults(speechText);
        };
        
        // Función para limpiar el filtro y mostrar todas las filas
        const clearTableFilter = () => {
            productsTableBody.querySelectorAll('tr').forEach(row => {
                row.classList.remove('filtered-out');
            });
            clearFilterButton.classList.add('hidden');
            statusDiv.innerHTML = '';
        };

        clearFilterButton.addEventListener('click', clearTableFilter);
        
        // Manejador de Búsqueda Manual (al presionar Enter en el input)
        productNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Evita envío de formulario
                const query = productNameInput.value.trim();
                performSearch(query);
            }
        });

        // Manejador de Búsqueda Manual (al hacer click en el icono de lupa)
        manualSearchButton.addEventListener('click', () => {
             const query = productNameInput.value.trim();
             performSearch(query);
        });


        // --- GESTIÓN DE BACKUPS PROGRAMADOS ---

        const loadBackupLog = () => {
            const storedLog = localStorage.getItem(BACKUP_LOG_KEY);
            backupLog = storedLog ? JSON.parse(storedLog) : [];
            renderBackupList();
        };

        const saveBackupLog = () => {
            localStorage.setItem(BACKUP_LOG_KEY, JSON.stringify(backupLog));
            renderBackupList();
        };

        const renderBackupList = () => {
            backupList.innerHTML = '';
            if (backupLog.length === 0) {
                backupList.innerHTML = '<li class="text-xs text-gray-500 text-center py-1">No hay backups.</li>';
                return;
            }

            // Ordenar por fecha descendente
            backupLog.sort((a, b) => new Date(b.date) - new Date(a.date));

            backupLog.forEach(log => {
                const li = document.createElement('li');
                // Uso de var(--color-text) para que el texto se vea bien en modo oscuro
                li.className = 'text-xs flex justify-between items-center hover:bg-gray-100 p-1 rounded-sm cursor-pointer';
                li.style.color = 'var(--color-text)'; 
                li.innerHTML = `
                    <span>${new Date(log.date).toLocaleString()}</span>
                    <button data-backup-id="${log.id}" class="text-red-500 hover:text-red-700 ml-2">X</button>
                `;
                li.querySelector('button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (window.confirm('¿Deseas eliminar este registro de backup?')) {
                        backupLog = backupLog.filter(b => b.id !== log.id);
                        saveBackupLog();
                    }
                });
                // Funcionalidad extra: descargar backup
                li.addEventListener('click', () => {
                    downloadBackupData(log.data, new Date(log.date));
                });

                backupList.appendChild(li);
            });
        };
        
        const downloadBackupData = (data, date) => {
            statusDiv.innerHTML = '<p class="text-yellow-600 font-bold">⌛ Creando copia de seguridad...</p>';
            try {
                // Reconstruir CSV a partir del array de objetos
                const csvContent = "Producto,Costo\n" + data.map(e => `${e.productName},${e.price}`).join("\n");

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_inventario_${date.toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                statusDiv.innerHTML = '<p class="text-yellow-600 font-bold">💾 Copia de seguridad CSV descargada exitosamente.</p>';

            } catch (error) {
                console.error("Error en la copia de seguridad:", error);
                statusDiv.innerHTML = `<p class="text-red-600 font-bold">🔴 Error en la copia de seguridad: ${error.message}</p>`;
            } finally {
                settingsMenu.classList.remove('open');
            }
        };

        const executeManualBackup = () => {
            if (currentProductsData.length === 0) {
                statusDiv.innerHTML = '<p class="text-yellow-600 font-bold">⚠️ No hay datos para respaldar.</p>';
                return;
            }

            const now = new Date();
            
            const backupData = currentProductsData.map(p => ({
                productName: p.productName,
                price: parseFloat(p.price).toFixed(2)
            }));
            
            backupLog.push({
                id: crypto.randomUUID(),
                date: now.toISOString(),
                data: backupData // Guardamos los datos reales para el download
            });
            saveBackupLog();
            downloadBackupData(backupData, now); // Descargar inmediatamente
        };
        
        const checkScheduledBackup = () => {
            const interval = backupIntervalSelect.value;
            if (interval === 'manual') return;

            // Lógica para determinar si ha pasado el intervalo desde el último backup
            const lastBackup = backupLog.length > 0 ? new Date(backupLog[0].date) : new Date(0);
            const now = new Date();
            let milliseconds = 0;

            switch (interval) {
                case 'daily': milliseconds = 24 * 60 * 60 * 1000; break;
                case '3days': milliseconds = 3 * 24 * 60 * 60 * 1000; break;
                case '5days': milliseconds = 5 * 24 * 60 * 60 * 1000; break;
                case 'monthly': milliseconds = 30 * 24 * 60 * 60 * 1000; break;
            }

            if (now.getTime() - lastBackup.getTime() >= milliseconds) {
                executeManualBackup();
                statusDiv.innerHTML = `<p class="text-green-600 font-bold">✅ Backup programado ejecutado.</p>`;
            }
        };

        // Escucha cambios en el selector de intervalo (guarda la configuración)
        backupIntervalSelect.addEventListener('change', () => {
            // Guardar la opción seleccionada en settings (opcional, pero buena práctica)
            currentSettings.backupInterval = backupIntervalSelect.value;
            saveSettings();
            
            // Re-establecer el cronómetro (si es necesario)
            if (backupTimer) clearInterval(backupTimer);

            if (backupIntervalSelect.value !== 'manual') {
                backupTimer = setInterval(checkScheduledBackup, 60 * 60 * 1000); // Revisar cada hora
                statusDiv.innerHTML = `<p class="text-blue-600 font-bold">Backup programado: ${backupIntervalSelect.options[backupIntervalSelect.selectedIndex].text}.</p>`;
            }
        });

        // Evento del botón de Backup Manual
        backupButton.addEventListener('click', executeManualBackup);


        // --- MANEJADORES DE RECONOCIMIENTO DE VOZ ---
        // (Lógica de voz sin cambios, utiliza la función performSearch ya modificada)

        const updateButtonStates = (isListening, mode) => {
            // ... (Lógica de updateButtonStates sin cambios) ...
            isRecognizing = isListening;
            if (mode === 'add') {
                startAddButtonText.textContent = isListening ? 'ESCUCHANDO...' : 'Agregar productos por voz';
                startAddButton.classList.toggle('listening-animation', isListening);
                startAddButton.classList.toggle('bg-red-500', isListening);
                startAddButton.classList.toggle('hover:bg-red-600', isListening);
                startAddButton.classList.toggle('bg-emerald-600', !isListening);
                startAddButton.classList.toggle('hover:bg-emerald-700', !isListening);
                startSearchButton.disabled = isListening;
            } else if (mode === 'search') {
                startSearchButtonText.textContent = isListening ? 'ESCUCHANDO BÚSQUEDA...' : 'Buscar producto por voz';
                startSearchButton.classList.toggle('listening-animation', isListening);
                startSearchButton.classList.toggle('bg-red-500', isListening);
                startSearchButton.classList.toggle('hover:bg-red-600', isListening);
                startSearchButton.classList.toggle('bg-blue-600', !isListening);
                startSearchButton.classList.toggle('hover:bg-blue-700', !isListening);
                startAddButton.disabled = isListening;
            }
        };

        recognition.onstart = () => {
            statusDiv.innerHTML = `<span class="flex items-center justify-center text-red-600 font-semibold"><div class="listening-dot w-2 h-2 bg-red-600 rounded-full mr-2"></div> ${currentMode === 'add' ? 'Di "Producto y Precio"...' : 'Di el nombre del artículo a buscar...'}</span>`;
            updateButtonStates(true, currentMode);
        };

        recognition.onend = () => {
            updateButtonStates(false, currentMode);
            if (statusDiv.textContent.includes('Di "Producto') || statusDiv.textContent.includes('Di el nombre del artículo')) {
                 statusDiv.textContent = '';
            }
        };

        recognition.onerror = (event) => {
            statusDiv.innerHTML = `<p class="text-red-600 font-bold">🔴 Error (${event.error}). Asegúrate de tener micrófono y permisos.</p>`;
            updateButtonStates(false, currentMode);
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            statusDiv.textContent = `📝 Transcripción: "${transcript}"`;
            
            if (currentMode === 'add') {
                const { product, price } = parseProductAndPrice(transcript);
                
                if (price !== null && !isNaN(parseFloat(price))) {
                    productNameInput.value = product;
                    priceInput.value = parseFloat(price).toFixed(2);
                    saveProductFromVoice(product, price);

                } else {
                    productNameInput.value = transcript.trim();
                    priceInput.value = '0.00';
                    statusDiv.innerHTML += `<p class="mt-1 text-red-600 font-bold">⚠️ Error: No se detectó un precio válido. Intenta de nuevo diciendo: "Producto [precio]".</p>`;
                }
            } else if (currentMode === 'search') {
                performSearchAndRead(transcript.trim());
            }
        };

        startAddButton.addEventListener('click', () => {
            currentMode = 'add';
            if (isRecognizing) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error("Error al iniciar el reconocimiento (Add):", error);
                    statusDiv.innerHTML = '<p class="text-yellow-600 font-bold">🟡 Ya se está escuchando o hubo un error al iniciar.</p>';
                }
            }
        });

        startSearchButton.addEventListener('click', () => {
            currentMode = 'search';
            if (isRecognizing) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error("Error al iniciar el reconocimiento (Search):", error);
                    statusDiv.innerHTML = '<p class="text-yellow-600 font-bold">🟡 Ya se está escuchando o hubo un error al iniciar la búsqueda.</p>';
                }
            }
        });

        // --- CORRECCIÓN CRÍTICA DEL BOTÓN DE ENGRANE ---

        // Abrir/Cerrar el menú
        settingsButton.addEventListener('click', (e) => {
            e.stopPropagation(); // Evita que el clic se propague al documento y lo cierre inmediatamente
            settingsMenu.classList.toggle('open');
        });

        // Cierra el menú si se hace clic fuera
        document.addEventListener('click', (e) => {
            // Aseguramos que el menú se cierre si no se hizo clic en el botón ni en el menú mismo.
            const isClickInsideMenu = settingsMenu.contains(e.target);
            const isClickOnButton = settingsButton.contains(e.target);
            
            if (settingsMenu.classList.contains('open') && !isClickInsideMenu && !isClickOnButton) {
                // No llamamos a recognition.stop() aquí, ya que interferiría con el proceso normal de voz.
                settingsMenu.classList.remove('open');
            }
        });
        
        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', () => {
             loadSettings();
             loadBackupLog(); // Cargar historial de backups
             renderProductsTable();
        });
    </script>

</body>
</html>


