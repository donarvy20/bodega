
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Productos para Bodega (Voz)</title>
    <!-- Carga de Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos personalizados para el botón de voz */
        .voice-btn {
            transition: all 0.2s;
        }
        .voice-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .voice-btn.recording {
            animation: pulse-recording 1.5s infinite;
            background-color: #ef4444; /* Rojo 500 */
        }
        @keyframes pulse-recording {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        /* El modo de escucha activa */
        .listening-mode { 
            background-color: #2563eb !important; /* Azul 600 */
            color: white !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800 mb-2">Gestión de Inventario de Bodega</h1>
            <p class="text-gray-600">Administración de productos con búsqueda por texto, voz y lectura automática de precios.</p>
            <div id="voice-status" class="mt-2 p-2 text-sm font-medium rounded-lg text-center bg-blue-100 text-blue-700 hidden">
                Haga clic en el micrófono para iniciar la búsqueda por voz.
            </div>
        </header>

        <!-- Sección de Búsqueda y Menú -->
        <div class="mb-8 p-6 bg-blue-50 rounded-lg shadow-inner">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                <h2 class="text-2xl font-semibold text-blue-700">Herramientas</h2>
                
                <div class="flex flex-wrap gap-2">
                    <!-- BOTÓN DE GUARDAR BACKUP -->
                    <button onclick="saveBackup()" class="voice-btn flex items-center bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-700 transition duration-150 shadow-lg text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M13 3h-2v10H8l4 4 4-4h-3zM19 18h2v2H3v-2h2v-1c0-2.21 1.79-4 4-4h6c2.21 0 4 1.79 4 4v1z"/>
                        </svg>
                        Guardar Backup
                    </button>
                    <!-- BOTÓN DE CARGAR BACKUP -->
                    <button onclick="openModal('restore-modal')" class="voice-btn flex items-center bg-yellow-400 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-yellow-500 transition duration-150 shadow-lg text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 16V9c0-.55.45-1 1-1h6c.55 0 1 .45 1 1v7l3-3 1.41 1.41L12 21 5.59 14.41 7 13l3 3V9H8v7H7z"/>
                        </svg>
                        Cargar Backup
                    </button>
                    <!-- BOTÓN PARA CARGA MASIVA (CSV/PASTE) -->
                    <button onclick="openModal('bulk-upload-modal')" class="voice-btn flex items-center bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 transition duration-150 shadow-lg text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                        Carga Masiva
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="search-input" oninput="searchProducts()" placeholder="Escriba el nombre del producto o use el micrófono..."
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm">

                <button id="voice-search-btn" class="voice-btn w-full md:w-auto flex items-center justify-center bg-red-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-600 transition duration-150 ease-in-out shadow-lg"
                        onclick="startVoiceSearch()">
                    <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.5-3c0 3.53-2.61 6.44-6 6.93V21h-1v-4.07c-3.39-.49-6-3.4-6-6.93h-2c0 4.84 3.65 8.8 8.44 9.49V23h3v-2.51c4.79-.69 8.44-4.65 8.44-9.49h-2z"/>
                    </svg>
                    <span id="voice-btn-text">Búsqueda por Voz</span>
                </button>
            </div>
        </div>

        <!-- Sección de Formulario CRUD -->
        <div class="mb-8 p-6 border border-gray-200 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4" id="form-title">Añadir Nuevo Producto</h2>
            <!-- Formulario simplificado a 2 columnas (Nombre y Precio) -->
            <form id="product-form" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <input type="hidden" id="product-id">
                
                <input type="text" id="product-name" placeholder="Nombre del Producto" required
                       class="sm:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                
                <!-- Stock eliminado -->
                
                <input type="number" id="product-price" placeholder="Precio (S/.)" required min="0.01" step="0.01"
                       class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                
                <button type="submit" id="submit-btn" class="sm:col-span-3 bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition duration-150 ease-in-out shadow-md">
                    <span id="submit-btn-text">Añadir Producto</span>
                </button>
            </form>
        </div>

        <!-- Sección de Lista de Productos -->
        <div class="overflow-x-auto shadow-xl rounded-xl">
            <table class="min-w-full bg-white divide-y divide-gray-200">
                <thead class="bg-blue-600 text-white">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">Nombre</th>
                        <!-- Stock eliminado de la cabecera -->
                        <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">Precio (S/.)</th>
                        <th class="px-3 py-3 text-center text-xs font-medium uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="product-list" class="bg-white divide-y divide-gray-100">
                    <!-- Los productos se insertarán aquí por JavaScript -->
                </tbody>
            </table>
        </div>
        <div id="no-products-message" class="text-center p-4 text-gray-500 mt-4 hidden">
            No se encontraron productos.
        </div>
    </div>

    <!-- Modal de Carga Masiva (CSV/Copia-Pega) -->
    <div id="bulk-upload-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-blue-800">Carga Masiva de Productos (CSV/Texto)</h3>
                <button onclick="closeModal('bulk-upload-modal')" class="text-gray-500 hover:text-gray-800 text-3xl font-light leading-none">&times;</button>
            </div>
            <p class="text-gray-600 mb-4 text-sm">Pegue los datos aquí. Cada producto debe estar en una línea separada. **Formato:** Nombre, Precio (separados por comas o saltos de línea).</p>
            
            <textarea id="bulk-data-input" rows="10" placeholder="Ejemplo:&#10;Leche Gloria, 4.50&#10;Pan Bimbo, 1.20&#10;Agua Cielo, 2.00"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm mb-4"></textarea>

            <button onclick="uploadBulkProducts()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-150 ease-in-out shadow-lg">
                Cargar Productos Masivamente
            </button>
            <div id="bulk-status" class="mt-4 text-sm text-red-600 font-medium"></div>
        </div>
    </div>
    
    <!-- Modal de Restauración de Backup (Cargar Archivo JSON) -->
    <div id="restore-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-800">Cargar Backup (.json)</h3>
                <button onclick="closeModal('restore-modal')" class="text-gray-500 hover:text-gray-800 text-3xl font-light leading-none">&times;</button>
            </div>
            <p class="text-gray-600 mb-4 text-sm font-semibold text-red-700">ADVERTENCIA: Esto reemplazará todo el inventario actual.</p>
            
            <input type="file" id="backup-file-input" accept=".json"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 shadow-sm mb-4">

            <button onclick="handleRestoreBackup()" class="w-full bg-yellow-600 text-white font-bold py-3 rounded-lg hover:bg-yellow-700 transition duration-150 ease-in-out shadow-lg">
                Restaurar Inventario
            </button>
            <div id="restore-status" class="mt-4 text-sm text-red-600 font-medium"></div>
        </div>
    </div>

    <script>
        // --- Variables Globales ---
        let products = [];
        let nextId = 1;
        const form = document.getElementById('product-form');
        const listContainer = document.getElementById('product-list');
        const searchInput = document.getElementById('search-input');
        const voiceBtn = document.getElementById('voice-search-btn');
        const voiceBtnText = document.getElementById('voice-btn-text');
        const voiceStatus = document.getElementById('voice-status');
        
        // ** ESTADO DE VOZ (Simplificado a solo 'escuchando') **
        let isStartingRecognition = false; 
        
        // --- Frases Aleatorias ---

        const notFoundPhrases = [
            "No encontré ese producto en el inventario. ¿Podría repetir o probar con otro nombre?",
            "Lo siento, la búsqueda no arrojó resultados para ese artículo. ¿Revisamos la ortografía?",
            "Parece que ese producto no está registrado. Intente con otra variación.",
            "No lo tengo en el inventario. Tal vez no está ingresado aún.",
            "Ese nombre no coincide con nada. ¿Desea buscar algo más?",
            "Busqué, pero no encontré coincidencias. Intente de nuevo.",
            "No hay resultados. ¿Quiere probar con una palabra clave diferente?",
            "El inventario no contiene ese artículo. ¿Le puedo ayudar con otra cosa?",
            "Búsqueda fallida. Por favor, especifique mejor el producto.",
        ];
        
        // ** PALABRAS IGNORADAS PARA MEJORAR LA BÚSQUEDA **
        // Se ignoran solo preposiciones y palabras de comando, NO las categorías de producto.
        const fillerWords = new Set([
            'a', 'ante', 'bajo', 'cabe', 'con', 'contra', 'de', 'del', 'desde', 'durante', 'en', 'entre',
            'hacia', 'hasta', 'mediante', 'para', 'por', 'según', 'sin', 'so', 'sobre', 'tras',
            'el', 'la', 'los', 'las', 'un', 'una', 'unos', 'unas', 'mi', 'su', 'es', 'está',
            'precio', 'precios', 'cuanto', 'como', 'esta', 'vale', 'costo', // Palabras de comando de precio
            'pequena', 'grande' // Descriptores de tamaño
        ]);

        /**
         * Selecciona una frase aleatoria de un array.
         */
        function getRandomPhrase(phraseArray) {
            const index = Math.floor(Math.random() * phraseArray.length);
            return phraseArray[index];
        }
        

        // --- Funciones de Utilidad ---

        /**
         * Normaliza el texto: lo convierte a minúsculas, elimina acentos y reemplaza 'ñ' por 'n'.
         * @param {string} text El texto a normalizar.
         * @returns {string} El texto normalizado.
         */
        function normalizeText(text) {
            if (!text) return '';
            // 1. Convertir a minúsculas
            // 2. Normalizar y eliminar diacríticos (acentos)
            // 3. Reemplazar 'ñ' por 'n'
            return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ñ/g, 'n');
        }

        /**
         * Implementación de Coincidencia Difusa (Fuzzy Like) mejorada.
         * ALTA PRECISIÓN: Solo coincide si la palabra buscada está fuertemente incluida,
         * tolerando acentos y variaciones fonéticas comunes (C/K, S/Z).
         * @param {string} normalizedProductName Nombre del producto (normalizado).
         * @param {string} searchToken Token de búsqueda (normalizado).
         * @returns {boolean} True si el token coincide de forma flexible.
         */
        function isFuzzyLikeMatch(normalizedProductName, searchToken) {
            
            // 1. Coincidencia Fonética/Tipográfica (C/K, S/Z) - MEJORA CLAVE
            // Crea un patrón flexible para S, C, Z, K. Esto asegura que 'cusqueña' encuentre 'cuzqueña'.
            // También se incluye la 'c' porque es un error común buscar 'k' en vez de 'c' (ej. 'kusqueña')
            let pattern = searchToken
                .replace(/[csz]/g, '[csz]') 
                .replace(/k/g, '[ck]');
            
            // La expresión regular busca la coincidencia del token dentro del nombre normalizado.
            // La palabra \b(pattern) asegura que la coincidencia sea al inicio de una palabra, lo cual mejora la precisión.
            const regex = new RegExp('\\b' + pattern, 'i'); 
            
            if (regex.test(normalizedProductName)) {
                return true;
            }
            
            // 2. Coincidencia simple de inclusión como fallback (si el regex falla)
            if (normalizedProductName.includes(searchToken)) {
                return true;
            }
            
            return false;
        }

        /**
         * Formatea el precio decimal a un string de voz claro (ej: 3.50 -> "tres soles con cincuenta céntimos").
         * @param {number} price El precio del producto.
         * @returns {string} El string formateado para la voz.
         */
        function formatPriceForSpeech(price) {
            if (isNaN(price)) return 'precio no disponible';
            
            // Redondear a dos decimales y separar partes
            const priceString = price.toFixed(2);
            const parts = priceString.split('.');
            const soles = parseInt(parts[0], 10);
            let centimos = parseInt(parts[1], 10);

            // Asegurar que los céntimos sean dos dígitos (ej: 5 -> 50)
            if (centimos < 10 && centimos > 0) {
                centimos = centimos * 10;
            } else if (centimos === 0) {
                return `${soles} soles exactos`;
            }

            const solesText = soles === 1 ? 'sol' : 'soles';
            const centimosText = centimos === 1 ? 'céntimo' : 'céntimos';

            if (soles === 0) {
                 return `${centimos} ${centimosText}`;
            }

            return `${soles} ${solesText} con ${centimos} ${centimosText}`;
        }


        function displayTemporaryMessage(message, classes) {
            // Cancelar cualquier mensaje anterior antes de mostrar el nuevo
            voiceStatus.className = 'hidden'; 
            
            voiceStatus.textContent = message;
            voiceStatus.className = `mt-2 p-2 text-sm font-medium rounded-lg text-center ${classes}`;
            voiceStatus.classList.remove('hidden');

            // Quitar el mensaje temporal, pero no si la voz está activa o está hablando
            setTimeout(() => {
                if (!isListening() && !synth.speaking) {
                    resetVoiceButton();
                }
            }, 3000); 
        }

        /**
         * Verifica si el reconocimiento de voz está actualmente activo.
         */
        function isListening() {
            return recognition && recognition.listening; 
        }

        // --- Funciones de Modal ---
        window.openModal = function(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            if(modalId === 'bulk-upload-modal') {
                document.getElementById('bulk-data-input').focus();
            }
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            if(modalId === 'bulk-upload-modal') {
                document.getElementById('bulk-status').textContent = ''; // Limpiar estado
                document.getElementById('bulk-data-input').value = ''; // Limpiar textarea
            }
            if(modalId === 'restore-modal') {
                document.getElementById('restore-status').textContent = '';
                document.getElementById('backup-file-input').value = '';
            }
        }
        
        // --- Funciones de Persistencia (localStorage) ---
        
        /**
         * Guarda el inventario actual y el ID consecutivo en el localStorage.
         */
        function saveProductsToLocalStorage() {
            try {
                const dataToSave = {
                    products: products,
                    nextId: nextId
                };
                localStorage.setItem('bodega_inventory', JSON.stringify(dataToSave));
            } catch (error) {
                console.error("Error al guardar en localStorage:", error);
            }
        }

        /**
         * Carga el inventario y el ID consecutivo desde el localStorage.
         * @returns {boolean} True si se encontraron datos guardados.
         */
        function loadProductsFromLocalStorage() {
            try {
                const storedData = localStorage.getItem('bodega_inventory');
                if (storedData) {
                    const data = JSON.parse(storedData);
                    if (Array.isArray(data.products)) {
                        products = data.products;
                        nextId = data.nextId || (products.length > 0 ? products[products.length - 1].id + 1 : 1);
                        return true;
                    }
                }
            } catch (error) {
                console.error("Error al cargar desde localStorage:", error);
                // Si el JSON está corrupto, lo borramos para evitar bucles de error.
                localStorage.removeItem('bodega_inventory'); 
            }
            return false;
        }

        // --- Funciones de Backup/Restore ---

        /**
         * Crea un backup del inventario y lo descarga como archivo JSON.
         */
        window.saveBackup = function() {
            const data = JSON.stringify({ products: products, nextId: nextId });
            const filename = `inventario_bodega_backup_${new Date().toISOString().slice(0, 10)}.json`;
            
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            displayTemporaryMessage('Backup del inventario guardado con éxito.', 'bg-green-100 text-green-700');
        }

        /**
         * Lee el archivo JSON del backup y llama a restoreInventory.
         */
        window.handleRestoreBackup = function() {
            const fileInput = document.getElementById('backup-file-input');
            const restoreStatus = document.getElementById('restore-status');
            const file = fileInput.files[0];
            
            restoreStatus.textContent = '';
            
            if (!file) {
                restoreStatus.textContent = "Error: Seleccione un archivo .json para restaurar.";
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    restoreInventory(backupData);
                    restoreStatus.classList.remove('text-red-600');
                    restoreStatus.classList.add('text-green-600');
                    restoreStatus.textContent = "¡Restauración exitosa! Inventario actualizado.";
                    setTimeout(() => closeModal('restore-modal'), 1500);
                } catch (error) {
                    restoreStatus.classList.remove('text-green-600');
                    restoreStatus.classList.add('text-red-600');
                    restoreStatus.textContent = "Error al leer o analizar el archivo JSON. Asegúrese de que el formato sea correcto.";
                    console.error("Error de restauración:", error);
                }
            };
            reader.readAsText(file);
        }

        /**
         * Reemplaza el inventario actual con los datos del backup.
         */
        function restoreInventory(backupData) {
            if (backupData && Array.isArray(backupData.products)) {
                products = backupData.products;
                nextId = backupData.nextId || products.length > 0 ? products[products.length - 1].id + 1 : 1;
                
                saveProductsToLocalStorage(); // Guardar el inventario restaurado
                renderProducts();
            } else {
                throw new Error("Formato de backup JSON inválido.");
            }
        }


        // --- Funciones de Reconocimiento de Voz ---

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        
        /** * Inicia la siguiente fase de reconocimiento.
         */
        function startNextRecognitionPhase(delay = 50) { 
            if (!recognition || isStartingRecognition) return;

            isStartingRecognition = true; // Bloquear nuevos intentos de start

            setTimeout(() => {
                try {
                    recognition.start();
                } catch (e) {
                    isStartingRecognition = false; // Liberar la bandera de bloqueo
                    
                    // Simplificar el catch para evitar UNHANDLEDREJECTION
                    if (e.name === 'InvalidStateError') {
                        console.warn("InvalidStateError: El start() falló. Esperando el siguiente ciclo onend/TTS.");
                    } else {
                        console.error("Error al iniciar reconocimiento:", e);
                        resetVoiceButton();
                    }
                }
            }, delay); 
        }

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES'; 
            recognition.interimResults = true; 
            recognition.maxAlternatives = 1;
            recognition.continuous = false; 
            recognition.interimResults = false;

            recognition.onstart = () => {
                if (window.speechSynthesis.speaking) window.speechSynthesis.cancel();
                
                voiceBtn.classList.add('recording', 'listening-mode');
                voiceBtn.classList.remove('active-mode'); 
                isStartingRecognition = false; 

                // UI para el modo de escucha directa
                voiceBtnText.textContent = 'Escuchando Producto...';
                voiceStatus.textContent = 'Diga la frase de búsqueda (ej. "precio de aceite").'; 
                
                voiceStatus.classList.add('bg-blue-100', 'text-blue-700');
                voiceStatus.classList.remove('hidden');
            };

            recognition.onresult = (event) => {
                let transcript = event.results[event.results.length - 1][0].transcript;
                // Limpiamos la transcripción y normalizamos para la comparación
                const cleanTranscript = transcript.replace(/[.,?!¡¿]/g, '').trim().toLowerCase(); 
                
                // Detenemos la grabación tan pronto como tenemos un resultado final
                recognition.stop(); 
                
                console.log(`[RECOGNISED] Transcripción limpia: ${cleanTranscript}`); 

                // --- BÚSQUEDA DIRECTA DE PRODUCTO ---
                if (cleanTranscript.length > 0) {
                    // Ponemos la transcripción completa en el input.
                    searchInput.value = transcript.trim();
                    
                    // Usar la transcripción limpia para la búsqueda
                    searchProducts(cleanTranscript); 
                } else {
                    // Si no se escuchó nada, resetear el botón si no hay TTS hablando
                    if (!synth.speaking) resetVoiceButton();
                }
            };

            recognition.onerror = (event) => {
                console.error('Error de reconocimiento de voz:', event.error);
                let message = 'Error en el reconocimiento de voz. Intente de nuevo.';
                
                if (event.error === 'not-allowed') {
                    message = 'Permiso de micrófono denegado. Haga clic en el botón para iniciar.';
                } else if (event.error === 'no-speech') {
                    // Si es no-speech, la sesión se cerró y onend se disparará para resetear el botón.
                    message = 'No se detectó su voz. Intente hablar más claro.';
                }
                
                recognition.stop();
                displayTemporaryMessage(message, 'bg-red-100', 'text-red-700');
            };
            
            // ** LÓGICA DE ESCUCHA - UNA SOLA VEZ **
            recognition.onend = () => {
                voiceBtn.classList.remove('recording');

                // Si no hay voz sintetizada hablando (de resultados), resetear el botón.
                // Si TTS está hablando (speakResults), su onend (callback) lo hará.
                if (!synth.speaking) {
                    resetVoiceButton();
                }
            };
        }

        function resetVoiceButton() {
            isStartingRecognition = false; 
            voiceBtn.classList.remove('recording', 'listening-mode', 'active-mode', 'bg-blue-500', 'hover:bg-blue-600');
            voiceBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            voiceBtnText.textContent = 'Búsqueda por Voz'; 
            voiceStatus.textContent = 'Haga clic en el micrófono para iniciar la búsqueda por voz.';
            voiceStatus.classList.add('bg-blue-100', 'text-blue-700');
            voiceStatus.classList.remove('bg-red-100', 'text-red-700', 'bg-yellow-100', 'text-yellow-700', 'bg-purple-100', 'text-purple-700');
        }

        // Toggle para controlar el ciclo de Búsqueda por Voz
        window.startVoiceSearch = function() {
            if (!recognition || isListening()) return;

            // Iniciar el reconocimiento de voz (single shot)
            startNextRecognitionPhase(50); 
        }

        // --- Funciones de Texto a Voz (TTS) ---

        const synth = window.speechSynthesis;
        let spanishVoice = null;
        let voicesLoaded = false;

        function loadVoices() {
            if (voicesLoaded) return;

            const voices = synth.getVoices();
            // Buscar una voz en español de España o Latinoamérica (cualquier es-*)
            spanishVoice = voices.find(voice => voice.lang.startsWith('es-'));
            voicesLoaded = true;

            if (!spanishVoice) {
                console.warn('No se encontró una voz en español. Se usará la voz predeterminada.');
            }
        }

        if (synth) {
            synth.onvoiceschanged = loadVoices;
            loadVoices(); 
            
            const TTS_RATE = 1.5; // Velocidad de voz acelerada

            /**
             * Función auxiliar para que la aplicación hable (ej. responder a un comando).
             */
             function speakPrompt(text, callback = null) {
                if (synth.speaking) {
                    synth.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES'; 
                utterance.rate = TTS_RATE;
                
                if (spanishVoice) {
                    utterance.voice = spanishVoice;
                }
                
                if (callback) {
                    utterance.onend = callback;
                }

                synth.speak(utterance);
            }
            
            window.speakProduct = function(id) {
                const product = products.find(p => p.id === id);
                if (!product) return;

                const priceString = formatPriceForSpeech(product.price); // Usar la nueva función
                const textToSpeak = `Producto: ${product.name}. Precio: ${priceString}.`; 
                
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'es-ES'; 
                utterance.rate = TTS_RATE;
                
                if (spanishVoice) {
                    utterance.voice = spanishVoice;
                }

                synth.speak(utterance);
                displayTemporaryMessage(`Leyendo: ${product.name}`, 'bg-purple-100 text-purple-700');
            }
            
            /**
             * Lee en voz alta todos los productos filtrados y los resultados de la búsqueda.
             */
            function speakResults(list) {
                if (!synth) return;

                // Cancelar cualquier lectura anterior
                if (synth.speaking) {
                    synth.cancel();
                }
                
                let textToSpeak = '';
                const count = list.length;

                if (count === 1) {
                    textToSpeak = `Se encontró un producto. `;
                } else if (count > 1) {
                    textToSpeak = `Se encontraron ${count} productos. `;
                } else {
                    // Si no hay resultados, seleccionar una frase de error aleatoria
                    textToSpeak = getRandomPhrase(notFoundPhrases);
                }

                list.forEach((product, index) => {
                    const priceString = formatPriceForSpeech(product.price); // Usar la nueva función
                    // Agregar una pequeña pausa (coma) entre productos.
                    // Lectura simplificada: Nombre y Precio
                    textToSpeak += `${index + 1}. ${product.name}. Precio ${priceString}. `; 
                });
                
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = 'es-ES'; 
                utterance.rate = TTS_RATE;
                
                if (spanishVoice) {
                    utterance.voice = spanishVoice;
                }

                // Mostrar mensaje de lectura activa
                displayTemporaryMessage(`Leyendo ${count} resultados...`, 'bg-purple-100 text-purple-700');

                utterance.onend = () => {
                    // Después de leer los resultados, reseteamos el botón.
                    resetVoiceButton();
                };

                synth.speak(utterance);
            }

        } else {
            console.error('El navegador no soporta Text-to-Speech.');
        }


        // --- Funciones de Gestión de Productos (CRUD) ---
        
        // ** NUEVA FUNCIÓN: CARGA MASIVA (CSV) **
        window.uploadBulkProducts = function() {
            const dataInput = document.getElementById('bulk-data-input').value.trim();
            const bulkStatus = document.getElementById('bulk-status');
            
            bulkStatus.textContent = ''; // Limpiar mensajes anteriores
            
            if (!dataInput) {
                bulkStatus.classList.remove('text-green-600');
                bulkStatus.classList.add('text-red-600');
                bulkStatus.textContent = "Error: Pegue los datos de los productos antes de intentar cargar.";
                return;
            }

            const lines = dataInput.split('\n');
            let successfulUploads = 0;
            let failedLines = [];
            
            // Expresión regular para separar por comas (CSV) o tabulaciones.
            const delimiterRegex = /[\t,]/; 

            lines.forEach((line, index) => {
                const lineNumber = index + 1;
                const cleanLine = line.trim();
                if (!cleanLine) return;
                
                // Dividir la línea por coma o tabulador
                const parts = cleanLine.split(delimiterRegex).map(p => p.trim()).filter(p => p.length > 0);
                
                // Formato esperado: Nombre, Precio (2 partes)
                if (parts.length < 2) {
                    failedLines.push(`Línea ${lineNumber}: Faltan datos (Nombre, Precio) o el formato es incorrecto.`);
                    return;
                }
                
                // Si el nombre tiene varias palabras, se usa la parte 0.
                const name = parts[0]; 
                // Stock ha sido eliminado, lo insertamos como un valor temporal para no romper la lógica antigua de datos.
                const quantity = 1; // Stock por defecto
                const price = parseFloat(parts[1]);

                // Validación de datos
                if (!name || isNaN(price) || price <= 0) { // Solo validamos Nombre y Precio
                    failedLines.push(`Línea ${lineNumber}: Datos de Precio inválidos. Nombre:'${parts[0]}', Precio:'${parts[1]}'.`);
                    return;
                }

                // Añadir el producto
                products.push({
                    id: nextId++,
                    name: name,
                    quantity: quantity, // Se mantiene por compatibilidad CRUD
                    price: price
                });
                successfulUploads++;
            });

            if (successfulUploads > 0) {
                // GUARDAR EN LOCAL STORAGE DESPUÉS DE LA CARGA MASIVA
                saveProductsToLocalStorage(); 

                // Mostrar resultados y actualizar la lista
                bulkStatus.classList.remove('text-red-600');
                bulkStatus.classList.add('text-green-600');
                bulkStatus.textContent = `¡Carga exitosa! Se añadieron ${successfulUploads} productos.`;
                
                // Si hay fallos, añadirlos al mensaje
                if (failedLines.length > 0) {
                    bulkStatus.textContent += ` Sin embargo, ${failedLines.length} líneas fallaron. Revise la consola para detalles.`;
                    console.error("Líneas fallidas en carga masiva:", failedLines.join('\n'));
                }

                renderProducts(searchInput.value);
                // Cierre el modal si el 100% de la carga fue exitosa.
                if (failedLines.length === 0) {
                    setTimeout(() => closeModal('bulk-upload-modal'), 1500); 
                }

            } else {
                bulkStatus.classList.remove('text-green-600');
                bulkStatus.classList.add('text-red-600');
                bulkStatus.textContent = "Error: No se pudo añadir ningún producto. Revise el formato (Nombre, Precio).";
            }
        }

        // Función para renderizar la lista de productos
        // Acepta un filterText opcional que puede venir de la voz.
        function renderProducts(filterText = searchInput.value) {
            // Detener la lectura de voz si el usuario cambia el filtro, A MENOS que se esté buscando por voz
            if (synth && synth.speaking && isListening()) {
                synth.cancel();
            }

            listContainer.innerHTML = '';
            
            // 1. Limpiar el filtro de espacios
            const trimmedFilterText = filterText.trim();
            
            // 2. Determinar si se debe hablar. SOLO si el filtro NO está vacío.
            const shouldSpeak = trimmedFilterText.length > 0;

            // ***********************************************************************************
            // *** Bloqueo de voz si el filtro está vacío ***
            // ***********************************************************************************
            if (trimmedFilterText.length === 0) {
                // Si el filtro está vacío, mostramos todos los productos ordenados.
                products.sort((a, b) => a.name.localeCompare(b.name));
                renderAll(products);

                if (!isListening() && !synth.speaking) {
                    resetVoiceButton();
                }
                return; // CLAVE: Salir de la función aquí para evitar la lógica de habla.
            }
            // ***********************************************************************************

            const normalizedFilter = normalizeText(trimmedFilterText);
            
            // 3. Obtener tokens de la búsqueda original.
            let searchTokens = normalizedFilter.split(/\s+/).filter(token => token.length > 0);
            
            // 4. Determinar si hay alguna palabra que NO sea de relleno
            const hasSpecificTerms = searchTokens.some(token => !fillerWords.has(token));
            
            // 5. Si hay términos específicos, filtrar las palabras de relleno para la búsqueda final.
            if (hasSpecificTerms) {
                searchTokens = searchTokens.filter(token => !fillerWords.has(token));
            }
            // Si hasSpecificTerms es falso, searchTokens conservará las palabras genéricas (como 'cerveza')
            // para permitir la búsqueda de categorías.


            let filteredProducts = products;

            if (searchTokens.length > 0) {
                 filteredProducts = products.filter(p => {
                    const normalizedProductName = normalizeText(p.name);
                    
                    // Aplica el filtro AND + Coincidencia difusa
                    return searchTokens.every(searchToken => {
                        return isFuzzyLikeMatch(normalizedProductName, searchToken);
                    });
                }).sort((a, b) => a.name.localeCompare(b.name));
            } 
            
            // Renderizamos la tabla con los resultados filtrados
            renderAll(filteredProducts);

            // **********************************************
            // ************ ACTIVACIÓN AUTOMÁTICA ***********
            // **********************************************
            if (synth && shouldSpeak) {
                // Si hay filtro (teclado o voz) y hay resultados (o no los hay), leer la respuesta.
                speakResults(filteredProducts);
            }
        }

        function renderAll(list) {
            listContainer.innerHTML = '';
            if (list.length === 0) {
                document.getElementById('no-products-message').classList.remove('hidden');
            } else {
                document.getElementById('no-products-message').classList.add('hidden');
            }

            list.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-100';

                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">S/. ${product.price.toFixed(2)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-right text-sm font-medium text-center space-x-2">
                        <button onclick="editProduct(${product.id})" class="text-blue-600 hover:text-blue-900 font-semibold px-2 py-1 rounded-md transition duration-150">
                            Editar
                        </button>
                        <button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-900 font-semibold ml-1 px-2 py-1 rounded-md transition duration-150">
                            Eliminar
                        </button>
                        <!-- BOTÓN DE LECTURA DE VOZ INDIVIDUAL -->
                        ${synth ? `<button onclick="speakProduct(${product.id})" class="text-purple-600 hover:text-purple-900 font-semibold ml-1 px-2 py-1 rounded-md transition duration-150">
                            Leer
                        </button>` : ''}
                    </td>
                `;
                listContainer.appendChild(row);
            });
        }

        // Manejador del formulario para añadir/editar
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value.trim();
            // Stock eliminado de la lectura del formulario
            const price = parseFloat(document.getElementById('product-price').value);

            // Validación simplificada
            if (!name || isNaN(price) || price <= 0) {
                displayTemporaryMessage('Por favor, complete todos los campos correctamente.', 'bg-yellow-100 text-yellow-700');
                return;
            }

            const newProductData = {
                name,
                // Stock (quantity) se mantiene por compatibilidad interna, pero no se muestra
                quantity: 1, 
                price
            };

            if (id) {
                // Editar producto existente
                const index = products.findIndex(p => p.id === parseInt(id));
                if (index > -1) {
                    // Mantener el quantity existente si se encuentra, sino usar 1 (para compatibilidad)
                    const existingQuantity = products[index].quantity || 1;
                    products[index] = { id: parseInt(id), quantity: existingQuantity, ...newProductData };
                    displayTemporaryMessage(`Producto "${name}" actualizado con éxito.`, 'bg-blue-100 text-blue-700');
                }
                resetForm();
            } else {
                // Añadir nuevo producto
                products.push({
                    id: nextId++,
                    ...newProductData
                });
                displayTemporaryMessage(`Producto "${name}" añadido al inventario.`, 'bg-green-100 text-green-700');
                form.reset();
            }

            saveProductsToLocalStorage(); // Guardar cambios
            renderProducts(searchInput.value);
        });

        // Carga los datos del producto en el formulario para editar
        window.editProduct = function(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-name').value = product.name;
                // document.getElementById('product-quantity').value = product.quantity; // Stock eliminado
                document.getElementById('product-price').value = product.price;

                // Actualiza el texto del formulario
                document.getElementById('form-title').textContent = `Editar Producto: ${product.name}`;
                document.getElementById('submit-btn-text').textContent = 'Guardar Cambios';
                document.getElementById('submit-btn').classList.remove('bg-green-500', 'hover:bg-green-600');
                document.getElementById('submit-btn').classList.add('bg-blue-500', 'hover:bg-blue-600');
            }
        }

        // Elimina un producto por ID
        window.deleteProduct = function(id) {
            const productIndex = products.findIndex(p => p.id === id);

            if (productIndex > -1) {
                const productName = products[productIndex].name;
                // Usamos window.confirm ya que es una acción destructiva
                const confirmation = '¿Está seguro que desea eliminar el producto: ' + productName + '?';

                if (window.confirm(confirmation)) {
                    products.splice(productIndex, 1);
                    saveProductsToLocalStorage(); // Guardar cambios
                    renderProducts(searchInput.value);
                    displayTemporaryMessage(`Producto "${productName}" eliminado.`, 'bg-red-100 text-red-700');
                    if (document.getElementById('product-id').value === String(id)) {
                        resetForm();
                    }
                }
            }
        }

        // Limpia el formulario y vuelve al modo 'Añadir'
        function resetForm() {
            document.getElementById('product-id').value = '';
            document.getElementById('form-title').textContent = 'Añadir Nuevo Producto';
            document.getElementById('submit-btn-text').textContent = 'Añadir Producto';
            document.getElementById('submit-btn').classList.add('bg-green-500', 'hover:bg-green-600');
            document.getElementById('submit-btn').classList.remove('bg-blue-500', 'hover:bg-blue-600');
            form.reset();
        }

        // --- Funciones de Búsqueda ---
        
        // MODIFICADA: Acepta el texto del input O un texto directo de la voz.
        window.searchProducts = function(voiceText = null) {
            const filterText = voiceText !== null ? voiceText : searchInput.value;
            
            // Si el texto viene de la voz, actualizar la caja de texto con la transcripción.
            if (voiceText !== null) {
                searchInput.value = filterText;
            }

            // Bloqueo de voz si se borra el input manualmente
            if (voiceText === null && filterText.trim().length === 0) {
                if (synth && synth.speaking) {
                    synth.cancel();
                }
            }
            
            renderProducts(filterText);
        }
        
        // Inicializar con datos de ejemplo
        function initializeApp() {
            // Intentar cargar datos guardados
            const dataLoaded = loadProductsFromLocalStorage();

            if (!dataLoaded) {
                 // Si no hay datos guardados, cargar datos iniciales (Stock ahora es solo 1 por compatibilidad interna)
                products.push({ id: nextId++, name: 'Arroz Costeño', quantity: 1, price: 15.00 });
                products.push({ id: nextId++, name: 'Aceite Primor', quantity: 1, price: 10.50 });
                products.push({ id: nextId++, name: 'Azúcar Rubia (Kg)', quantity: 1, price: 3.50 });
                products.push({ id: nextId++, name: 'Queso Fresco (Kg)', quantity: 1, price: 25.00 }); 
                products.push({ id: nextId++, name: 'Fideos Don Vittorio', quantity: 1, price: 4.20 });
                products.push({ id: nextId++, name: 'Gaseosa Inca Kola (3L)', quantity: 1, price: 8.00 });
                products.push({ id: nextId++, name: 'Triángulo de Donofrio', quantity: 1, price: 2.50 }); 
                products.push({ id: nextId++, name: 'Pasta Dental Kolinos', quantity: 1, price: 7.00 });
                products.push({ id: nextId++, name: 'Cerveza Pilsen (Lata)', quantity: 1, price: 4.50 }); 
                products.push({ id: nextId++, name: 'Cuzqueña en Lata Pequeña', quantity: 1, price: 5.00 }); // Producto de prueba para S/Z
                products.push({ id: nextId++, name: 'Paquete Always Grande', quantity: 1, price: 12.00 }); 
                products.push({ id: nextId++, name: 'Leche Pequeña Nestlé', quantity: 1, price: 2.50 }); 

                nextId = products.length + 1;
                saveProductsToLocalStorage(); // Guardar los datos iniciales
            }
            
            renderProducts();
            
            // ** INICIO AUTOMÁTICO **
            window.onload = () => {
                resetVoiceButton(); // Asegurar estado inicial
                displayTemporaryMessage('Haga clic en el botón rojo para iniciar la búsqueda por voz.', 'bg-yellow-100', 'text-yellow-700');
            };
        }

        initializeApp();

    </script>
</body>
</html>


